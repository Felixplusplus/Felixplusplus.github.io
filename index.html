<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>匀昊的旧笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta property="og:type" content="website">
<meta property="og:title" content="匀昊的旧笔记">
<meta property="og:url" content="https://felixplusplus.github.io/index.html">
<meta property="og:site_name" content="匀昊的旧笔记">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="匀昊的旧笔记">
  
    <link rel="alternate" href="/atom.xml" title="匀昊的旧笔记" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/home.css" >
  

  

  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

</head>



  <body>


  
    <header id="header">

	<!-- 背景图模式 -->
	

    
      <div id="intrologo" class="intro-logo" style="background-position:center; background-repeat:no-repeat; background-image: url(); background-size: auto 100%;">

      <!-- Support rolling -->  
        
        <section class="awSlider">
          <div class="carousel slide carousel-fade " data-ride="carousel">

            <!-- Wrapper for slides -->
            <div class="carousel-inner">
               
                  
                    <div class="item active">
                  
                    <img id="carousel-img0" src="/css/images/home-bg.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img0 = new Image();
                      var imageTag0 = document.getElementById("carousel-img0");
                      img0.src = imageTag0.src;
                      img0.onload=function(){
                        if (img0.width / img0.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag0.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag0.style.height = document.body.clientHeight + "px";
                          imageTag0.style.marginLeft = -(document.body.clientHeight * img0.width / img0.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img1" src="/css/images/sample.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img1 = new Image();
                      var imageTag1 = document.getElementById("carousel-img1");
                      img1.src = imageTag1.src;
                      img1.onload=function(){
                        if (img1.width / img1.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag1.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag1.style.height = document.body.clientHeight + "px";
                          imageTag1.style.marginLeft = -(document.body.clientHeight * img1.width / img1.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img2" src="https://source.unsplash.com/collection/954550/1920x1080">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img2 = new Image();
                      var imageTag2 = document.getElementById("carousel-img2");
                      img2.src = imageTag2.src;
                      img2.onload=function(){
                        if (img2.width / img2.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag2.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag2.style.height = document.body.clientHeight + "px";
                          imageTag2.style.marginLeft = -(document.body.clientHeight * img2.width / img2.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
            </div>

            <!-- Controls -->
            <a class="left carousel-control" href=".carousel" role="button" data-slide="prev">
              <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
              <span class="sr-only">Geri</span>
            </a>
            <a class="right carousel-control" href=".carousel" role="button" data-slide="next">
              <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
              <span class="sr-only">İleri</span>
            </a>
          </div>
        </section>
        <script>
          $('section.awSlider .carousel').carousel({
              pause: '',
              interval: 5000
          });
          var startImage = $('section.awSlider .item.active > img').attr('src');
          $('section.awSlider .carousel').on('slid.bs.carousel', function () {
              var bscn = $(this).find('.item.active > img').attr('src');
              $('section.awSlider > img').attr('src', bscn);
          });
        </script>
      

    
 


    <canvas width="100%" height="100%"></canvas>
    <script>
      var c = document.getElementsByTagName('canvas')[0],
          x = c.getContext('2d'),
          w = window.innerWidth,
          h = window.innerHeight,
          pr = window.devicePixelRatio || 1,
          f = 90,
          q,
          m = Math,
          r = 0,
          u = m.PI*2,
          v = m.cos,
          z = m.random
      c.width = w*pr
      c.height = h*pr
      x.scale(pr, pr)
      x.globalAlpha = 0.6

      <!-- 折线Polyline背景 -->
      
    </script>
    

    
      <div id="homelogo" class="homelogo" style="background: rgba(255,255,255,1);"> 
    

        
          <div class="homelogoback"  style="border: 1px solid #404040;" >
            <h1><a href="#content" id="logo">匀昊的旧笔记</a></h1>
            <h3></h3>
            <h5>匀昊</h5>
            <!-- <p><a href="https://github.com/iTimeTraveler" target="_blank">Github</a></p> -->
          </div>
        
    
    </div>
  </div>

  <!-- 自适应主页背景大图 -->
  

 <!-- home_logo_image居中 -->
 
    <script>
        var homelogodiv = document.getElementById("homelogo");
        if (document.all.homelogo.offsetWidth > document.body.clientWidth) {
          homelogodiv.style.width = document.body.clientWidth + "px";
          homelogodiv.style.marginLeft = document.body.clientWidth * -0.5 + "px";
        } else {
          homelogodiv.style.width = homelogodiv.clientWidth  + "px";
          homelogodiv.style.marginLeft = (homelogodiv.clientWidth)  * -0.5 + "px";
        }
    </script>
  

  <div class="intro-navigate">
      <p class="navigater-list">
        
          <a id="beautifont" class="main-nav-link" href="/">Home</a>
        
          <a id="beautifont" class="main-nav-link" href="/archives">Archives</a>
        
          <a id="beautifont" class="main-nav-link" href="/tags">Tags</a>
        
          <a id="beautifont" class="main-nav-link" href="/about">About</a>
        
      </p>
  </div>

</header>
  
  <div id="container">
    <div id="wrap">
      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;">
  
    <article id="post-lldb"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/08/27/lldb/">大话lldb</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/08/27/lldb/" class="article-date">
	  <time datetime="2018-08-27T07:06:47.000Z" itemprop="datePublished">2018-08-27</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="lldb-简介"><a href="#lldb-简介" class="headerlink" title="lldb 简介"></a>lldb 简介</h1><h2 id="lldb-是什么"><a href="#lldb-是什么" class="headerlink" title="lldb 是什么"></a>lldb 是什么</h2><p>lldb 是我们日常开发用来调试的命令行工具</p>
<h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><h1 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h1><h2 id="Chisel"><a href="#Chisel" class="headerlink" title="Chisel"></a>Chisel</h2><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      
    </div>
    <footer class="article-footer">
      
      
      
        
      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-swiftBlockChain"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/08/11/swiftBlockChain/">使用swift搭建简易区块链并实现使用webApi进行调度</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/08/11/swiftBlockChain/" class="article-date">
	  <time datetime="2018-08-11T03:28:28.000Z" itemprop="datePublished">2018-08-11</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Reason"><a href="#Reason" class="headerlink" title="Reason"></a>Reason</h1><p>最近特别好奇比特币为啥那么贵 ， 那么多人去炒 ， 所以先了解一下区块链 ， 并使用swift实现一个练练手</p>
<p><a href="https://github.com/Felixplusplus/blockChainServer" target="_blank" rel="noopener">源码地址</a></p>
<h1 id="BlockChain"><a href="#BlockChain" class="headerlink" title="BlockChain"></a>BlockChain</h1><blockquote>
<p>所谓区块链技术 ， 简称BT（Blockchain technology），也被称之为分布式账本技术，是一种互联网数据库技术，其特点是去中心化、公开透明，让每个人均可参与数据库记录。</p>
</blockquote>
<h2 id="Base"><a href="#Base" class="headerlink" title="Base"></a>Base</h2><ul>
<li>交易（Transaction）：一次操作，导致账本状态的一次改变，如添加一条记录；</li>
<li>区块（Block）：记录一段时间内发生的交易和状态结果，是对当前账本状态的一次共识；</li>
<li>链（Chain）：由一个个区块按照发生顺序串联而成，是整个状态变化的日志记录。</li>
</ul>
<blockquote>
<p>如果把区块链作为一个状态机，则每次交易就是试图改变一次状态，而每次共识生成的区块，就是参与者对于区块中所有交易内容导致状态改变的结果进行确认。</p>
</blockquote>
<h2 id="阐述"><a href="#阐述" class="headerlink" title="阐述"></a>阐述</h2><blockquote>
<p>用通俗的话阐述：如果我们把数据库假设成一本账本，读写数据库就可以看做一种记账的行为，区块链技术的原理就是在一段时间内找出记账最快最好的人，由这个人来记账，然后将账本的这一页信息发给整个系统里的其他所有人。这也就相当于改变数据库所有的记录，发给全网的其他每个节点，所以区块链技术也称为分布式账本（distributed ledger）。</p>
</blockquote>
<h1 id="Vapor"><a href="#Vapor" class="headerlink" title="Vapor"></a>Vapor</h1><p>既然要用swift实现 ， 我在这里就选择vapor作为服务端框架来使用 ， vapor里面有意思的东西很多 ， 这里只介绍基本的操作而不深究其原理 。</p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p>前置条件 ， 这里我们使用macOS进行开发部署 ， 以下是需要软件和版本。</p>
<ul>
<li>Install Xcode 9.3 or greater from the Mac App Store.</li>
<li>Vapor requires Swift 4.1 or greater.</li>
<li>Vapor Toolbox: 3.1.7</li>
<li>Vapor Framework: 3.0.8</li>
<li>homeBrew</li>
</ul>
<p>接着使用homeBrew安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install vapor/tap/vapor</span><br></pre></td></tr></table></figure>
<h2 id="Get-Started"><a href="#Get-Started" class="headerlink" title="Get Started"></a>Get Started</h2><p>现在vapor已经装好了 ， 我们可以先把基本的准备工作弄好</p>
<p>使用vapor初始化工程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vapor new blockChainServer</span><br></pre></td></tr></table></figure>
<p>生成工程文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vapor xcode</span><br></pre></td></tr></table></figure>
<p>接着打开 blockChainServer.xcodeproj 文件 ， 在导航上的schema上选择 run ，接着按下 command + R </p>
<p>这时你应能够在控制台看到输出的server地址了</p>
<h1 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h1><p>到现在我们一切准备工作都就绪了 ， 那么开始鼓捣个区块链api出来吧 。</p>
<h2 id="Base-model"><a href="#Base-model" class="headerlink" title="Base model"></a>Base model</h2><p>区块链的基本概念上面介绍了 ， 包含以下几类 ， 我们使用oop可以抽象出以下一堆class</p>
<ul>
<li>Transaction     交易</li>
<li>Block           区块</li>
<li>Blockchain      区块链</li>
<li>BlockChainNode  区块链节点</li>
</ul>
<p>排列由下向上存在集合关系 。 </p>
<p>其实这里面最后应该加上一个区块网络 ， 不过这里我们暂时不需要实现全部网络 ， 搞个内网的先耍耍就好</p>
<p>下面分别来看下几个model的代码</p>
<p>ps:这里的框架添加的协议和扩展很多 ， 不在此过多介绍 ， 请把关注点放在class本身</p>
<p>Transaction.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> FluentSQLite</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span>: <span class="title">Codable</span>,<span class="title">SQLiteModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">Int</span>?</span><br><span class="line">    <span class="keyword">var</span> from: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> to: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> amount: <span class="type">Double</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(from: <span class="type">String</span>, to: <span class="type">String</span>, amount: <span class="type">Double</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.from = from</span><br><span class="line">        <span class="keyword">self</span>.to = to</span><br><span class="line">        <span class="keyword">self</span>.amount = amount</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Transaction</span>: <span class="title">Content</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Transaction</span>: <span class="title">Migration</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Transaction</span>: <span class="title">Parameter</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>这里我们可以看到定义了几个property ， </p>
<ul>
<li>id是SQLiteModel协议需要实现的 ， 这里只要记住是为了数据持久化就好</li>
<li>to : 交易的接收方</li>
<li>from : 交易的发起方</li>
<li>amount : 金额</li>
</ul>
<p>Block.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FluentSQLite</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Block</span>: <span class="title">Codable</span>,<span class="title">SQLiteModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">Int</span>?</span><br><span class="line">    <span class="keyword">var</span> index: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> dateCreated: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> previousHash: <span class="type">String</span>!</span><br><span class="line">    <span class="keyword">var</span> hash: <span class="type">String</span>!</span><br><span class="line">    <span class="keyword">var</span> nonce: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">var</span> message: <span class="type">String</span> = <span class="string">""</span></span><br><span class="line">    <span class="keyword">private</span> (<span class="keyword">set</span>) <span class="keyword">var</span> transactions: [<span class="type">Transaction</span>] = [<span class="type">Transaction</span>]()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> key: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> transactionsData = <span class="keyword">try</span>! <span class="type">JSONEncoder</span>().encode(transactions)</span><br><span class="line">            <span class="keyword">let</span> transactionsJSONString = <span class="type">String</span>(data: transactionsData, encoding: .utf8)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="type">String</span>(index) + dateCreated + previousHash + transactionsJSONString! + <span class="type">String</span>(nonce)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @discardableResult</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addTransaction</span><span class="params">(transaction: Transaction)</span></span> -&gt; <span class="type">Block</span>&#123;</span><br><span class="line">        transactions.append(transaction)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        dateCreated = <span class="type">Date</span>().<span class="built_in">toString</span>()</span><br><span class="line">        nonce = <span class="number">0</span></span><br><span class="line">        message = <span class="string">"挖出新的区块"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(transaction: <span class="type">Transaction</span>) &#123;</span><br><span class="line">        dateCreated = <span class="type">Date</span>().<span class="built_in">toString</span>()</span><br><span class="line">        nonce = <span class="number">0</span></span><br><span class="line">        addTransaction(transaction: transaction)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Block</span>: <span class="title">Content</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Block</span>: <span class="title">Migration</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Block</span>: <span class="title">Parameter</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>index : 区块序号</li>
<li>dateCreated : 创建日期</li>
<li>previousHash : 前一个区块的哈希值 </li>
<li>hash : 当前区块的哈希值</li>
<li>nonce : 先记住和工作量证明有关 </li>
<li>message : 这里是为了我们看到输出</li>
</ul>
<p>Blockchain.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> FluentSQLite</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span>: <span class="title">Codable</span>,<span class="title">SQLiteModel</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">Int</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> blocks: [<span class="type">Block</span>] = [<span class="type">Block</span>]()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> genesisBlock: <span class="type">Block</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.addBlock(genesisBlock)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addBlock</span><span class="params">(<span class="number">_</span> block: Block)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.blocks.isEmpty &#123;</span><br><span class="line">            <span class="comment">// 添加创世区块</span></span><br><span class="line">            <span class="comment">// 第一个区块没有 previous hash</span></span><br><span class="line">            block.previousHash = <span class="string">"0"</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> previousBlock = getPreviousBlock()</span><br><span class="line">            block.previousHash = previousBlock.hash</span><br><span class="line">            block.index = <span class="keyword">self</span>.blocks.<span class="built_in">count</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        block.hash = generateHash(<span class="keyword">for</span>: block)</span><br><span class="line">        <span class="keyword">self</span>.blocks.append(block)</span><br><span class="line">        block.message = <span class="string">"此区块已添加至区块链"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">getPreviousBlock</span><span class="params">()</span></span> -&gt; <span class="type">Block</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.blocks[<span class="keyword">self</span>.blocks.<span class="built_in">count</span> - <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">displayBlock</span><span class="params">(<span class="number">_</span> block: Block)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"------ 第 \(block.index) 个区块 --------"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"创建日期：\(block.dateCreated)"</span>)</span><br><span class="line">        <span class="comment">// print("数据：\(block.data)")</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Nonce：\(block.nonce)"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"前一个区块的哈希值：\(block.previousHash!)"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"哈希值：\(block.hash!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">generateHash</span><span class="params">(<span class="keyword">for</span> block: Block)</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> hash = block.key.sha1Hash()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置工作量证明</span></span><br><span class="line">        <span class="keyword">while</span>(!hash.hasPrefix(<span class="string">"11"</span>)) &#123;</span><br><span class="line">            block.nonce += <span class="number">1</span></span><br><span class="line">            hash = block.key.sha1Hash()</span><br><span class="line">            <span class="built_in">print</span>(hash)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hash</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Blockchain</span>: <span class="title">Content</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Blockchain</span>: <span class="title">Migration</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Blockchain</span>: <span class="title">Parameter</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>BlockChainNode.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FluentSQLite</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockChainNode</span>: <span class="title">Codable</span>,<span class="title">SQLiteModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">Int</span>?</span><br><span class="line">    <span class="keyword">var</span> address :<span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(addr:<span class="type">String</span>) &#123;</span><br><span class="line">        address = addr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BlockChainNode</span>: <span class="title">Content</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BlockChainNode</span>: <span class="title">Migration</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">BlockChainNode</span>: <span class="title">Parameter</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>address : 节点地址</li>
</ul>
<h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><p>这里涉及到的事件主要是计算hash ， 我们在这里面给String 添加一个extension</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">String</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">sha1Hash</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> task = <span class="type">Process</span>()</span><br><span class="line">        task.launchPath = <span class="string">"/usr/bin/shasum"</span></span><br><span class="line">        task.arguments = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> inputPipe = <span class="type">Pipe</span>()</span><br><span class="line">        </span><br><span class="line">        inputPipe.fileHandleForWriting.write(<span class="keyword">self</span>.data(using: .utf8)!)</span><br><span class="line">        </span><br><span class="line">        inputPipe.fileHandleForWriting.closeFile()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> outputPipe = <span class="type">Pipe</span>()</span><br><span class="line">        task.standardOutput = outputPipe</span><br><span class="line">        task.standardInput = inputPipe</span><br><span class="line">        task.launch()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> data = outputPipe.fileHandleForReading.readDataToEndOfFile()</span><br><span class="line">        <span class="keyword">let</span> hash = <span class="type">String</span>(data: data, encoding: .utf8)!</span><br><span class="line">        <span class="keyword">return</span> hash.replacingOccurrences(of: <span class="string">"  -\n"</span>, with: <span class="string">""</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给date也添加一个便于我们输出区块创建时间</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Date</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">toString</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> formatter = <span class="type">DateFormatter</span>()</span><br><span class="line">        formatter.dateFormat = <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">        <span class="keyword">return</span> formatter.string(from: <span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>在这里我们把所有对区块链的操作抽象为一个service类</p>
<p>BlockchainService.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlockchainService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> blockchain: <span class="type">Blockchain</span> = <span class="type">Blockchain</span>()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> nodes = [<span class="type">BlockChainNode</span>]()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addBlock</span><span class="params">(<span class="number">_</span> block: Block)</span></span> -&gt; <span class="type">Block</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.blockchain.addBlock(block)</span><br><span class="line">        <span class="keyword">return</span> block</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getLastBlock</span><span class="params">()</span></span> -&gt; <span class="type">Block</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> lastB = <span class="keyword">self</span>.blockchain.blocks.last <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> addBlock(<span class="type">Block</span>())</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lastB;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getBlockchain</span><span class="params">()</span></span> -&gt; <span class="type">Blockchain</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.blockchain</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">registerNode</span><span class="params">(<span class="number">_</span> node:BlockChainNode)</span></span> -&gt; <span class="type">BlockChainNode</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.nodes.append(node)</span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getAllNodes</span><span class="params">()</span></span> -&gt; [<span class="type">BlockChainNode</span>] &#123;</span><br><span class="line">        <span class="keyword">return</span> nodes</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Controller-amp-Router"><a href="#Controller-amp-Router" class="headerlink" title="Controller &amp; Router"></a>Controller &amp; Router</h2><p>这里我们基本完成了所有基本模型的搭建 ， 现在需要对我们的server进行操作 ， 让我们可以方便的通过curl调用我们的区块链系统 。</p>
<p>BlockChainController.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BCError</span>:<span class="title">LocalizedError</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockChainController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> bcService = <span class="type">BlockchainService</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addBlock</span><span class="params">(<span class="number">_</span> req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">Block</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> bcService.addBlock(<span class="type">Block</span>()).save(on: req)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addTransaction</span><span class="params">(<span class="number">_</span> req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">Block</span>&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> req.content.decode(<span class="type">Transaction</span>.<span class="keyword">self</span>).flatMap&#123; transation <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.bcService.getLastBlock().addTransaction(transaction: transation).save(on: req)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">findBlockChain</span><span class="params">(<span class="number">_</span> req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">Blockchain</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> bcService.getBlockchain().save(on: req)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">registeNode</span><span class="params">(<span class="number">_</span> req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">BlockChainNode</span>&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> req.content.decode(<span class="type">BlockChainNode</span>.<span class="keyword">self</span>).flatMap&#123; node <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.bcService.registerNode(node).save(on: req)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">allNodes</span><span class="params">(<span class="number">_</span> req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;[<span class="type">BlockChainNode</span>]&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="type">BlockChainNode</span>.query(on: req).all()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">resolve</span><span class="params">(<span class="number">_</span> req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">Blockchain</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> promise = req.eventLoop.newPromise(<span class="type">Blockchain</span>.<span class="keyword">self</span>)</span><br><span class="line">        </span><br><span class="line">        bcService.getAllNodes().forEach &#123; node <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"http://\(node.address)/blockchain"</span>) <span class="keyword">else</span> &#123;<span class="keyword">return</span> promise.fail(error: <span class="type">BCError</span>(name: <span class="string">"node error"</span>))&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">URLSession</span>.shared.dataTask(with: url, completionHandler: &#123; (data, <span class="number">_</span>, <span class="number">_</span>) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> data = data &#123;</span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> bc = <span class="keyword">try</span>? <span class="type">JSONDecoder</span>().decode(<span class="type">Blockchain</span>.<span class="keyword">self</span>, from: data) <span class="keyword">else</span> &#123;<span class="keyword">return</span> promise.fail(error: <span class="type">BCError</span>(name: <span class="string">"json error"</span>))&#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">self</span>.bcService.getBlockchain().blocks.<span class="built_in">count</span> &lt; bc.blocks.<span class="built_in">count</span> &#123;</span><br><span class="line">                        <span class="keyword">self</span>.bcService.getBlockchain().blocks = bc.blocks</span><br><span class="line">                    &#125;</span><br><span class="line">                    promise.succeed(result: <span class="keyword">self</span>.bcService.getBlockchain())</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    promise.fail(error: <span class="type">BCError</span>(name: <span class="string">"data Error"</span>))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).resume()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> promise.futureResult</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>routes.swift</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Register your application's routes here.</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">routes</span><span class="params">(<span class="number">_</span> router: Router)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="comment">// Basic "Hello, world!" example</span></span><br><span class="line">    router.<span class="keyword">get</span>(<span class="string">"hello"</span>) &#123; req <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello, world!"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> bcc = <span class="type">BlockChainController</span>()</span><br><span class="line">    router.post(<span class="string">"block"</span>, use: bcc.addBlock)</span><br><span class="line">    router.post(<span class="string">"transaction"</span>, use: bcc.addTransaction)</span><br><span class="line">    router.<span class="keyword">get</span>(<span class="string">"blockchain"</span>, use: bcc.findBlockChain)</span><br><span class="line">    router.post(<span class="string">"node"</span>, use: bcc.registeNode)</span><br><span class="line">    router.<span class="keyword">get</span>(<span class="string">"node"</span>, use: bcc.allNodes)</span><br><span class="line">    router.post(<span class="string">"resolve"</span>, use: bcc.resolve)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在解释一下我们注册的api都是干啥的</p>
<p>ps:API层遵守restfull</p>
<ul>
<li>post(“block”, use: bcc.addBlock) 增加一个区块</li>
<li>post(“transaction”, use: bcc.addTransaction) 新增一笔交易</li>
<li>get(“blockchain”, use: bcc.findBlockChain) 查询区块链</li>
<li>post(“node”, use: bcc.registeNode) 增加节点</li>
<li>get(“node”, use: bcc.allNodes) 获取全部节点</li>
<li>post(“resolve”, use: bcc.resolve) 解决冲突</li>
</ul>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>下面我们可以让服务运行起来 ， 然后通过curl命令行来调用区块链系统 ，</p>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><p>进入我们的工程目录 ， 执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vapor build</span><br></pre></td></tr></table></figure>
<p>你应能看到以下输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Building Project [Done]</span><br></pre></td></tr></table></figure>
<p>这说明我们的工程可以运行了</p>
<h3 id="运行工程"><a href="#运行工程" class="headerlink" title="运行工程"></a>运行工程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vapor run serve --port=8080</span><br></pre></td></tr></table></figure>
<p>我们在本地8080端口上开启我们的服务</p>
<p>这时应能看到如下输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Running blockChainServer ...</span><br><span class="line">[ INFO ] Migrating <span class="string">'sqlite'</span> database (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/MigrationConfig.swift:69)</span><br><span class="line">[ INFO ] Preparing migration <span class="string">'Todo'</span> (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/Migrations.swift:111)</span><br><span class="line">[ INFO ] Preparing migration <span class="string">'Block'</span> (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/Migrations.swift:111)</span><br><span class="line">[ INFO ] Preparing migration <span class="string">'Blockchain'</span> (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/Migrations.swift:111)</span><br><span class="line">[ INFO ] Preparing migration <span class="string">'BlockChainNode'</span> (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/Migrations.swift:111)</span><br><span class="line">[ INFO ] Migrations complete (/Users/felix/Documents/TestFolder/blockChainServer/.build/checkouts/fluent.git-6251908308727715749/Sources/Fluent/Migration/MigrationConfig.swift:73)</span><br><span class="line">[Deprecated] --option=value syntax is deprecated. Please use --option value (with no =) instead.</span><br><span class="line">Server starting on http://localhost:8080</span><br></pre></td></tr></table></figure>
<p>现在我们只要用api调用以下 ， 本机的区块链系统就会响应了 ， 让我们试一下吧</p>
<h3 id="创建区块"><a href="#创建区块" class="headerlink" title="创建区块"></a>创建区块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X POST localhost:8080/block</span><br></pre></td></tr></table></figure>
<p>你会在一段时间后看到响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:19:01"</span>,</span><br><span class="line">    <span class="attr">"hash"</span>: <span class="string">"1124aa2a5867abee8b9cc3a3f4051b6665f89e26"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"index"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">    <span class="attr">"nonce"</span>: <span class="number">193</span>,</span><br><span class="line">    <span class="attr">"previousHash"</span>: <span class="string">"0"</span>,</span><br><span class="line">    <span class="attr">"transactions"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的第一个block已经创建成功并且被加入区块链里了 ， 他的previousHash为“0”是因为他是创世区块 。</p>
<h3 id="添加交易"><a href="#添加交易" class="headerlink" title="添加交易"></a>添加交易</h3><p>我们可以在这里添加几笔交易看看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X POST localhost:8080/transaction --data <span class="string">"from=Felix&amp;to=mayun&amp;amount=100"</span> | python -m json.tool</span><br></pre></td></tr></table></figure>
<p>data里面表示 Felix向mayun转账100 每次添加后你将会得到区块的最新信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:19:01"</span>,</span><br><span class="line">    <span class="attr">"hash"</span>: <span class="string">"1124aa2a5867abee8b9cc3a3f4051b6665f89e26"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"index"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">    <span class="attr">"nonce"</span>: <span class="number">193</span>,</span><br><span class="line">    <span class="attr">"previousHash"</span>: <span class="string">"0"</span>,</span><br><span class="line">    <span class="attr">"transactions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"amount"</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">"from"</span>: <span class="string">"Felix"</span>,</span><br><span class="line">            <span class="attr">"to"</span>: <span class="string">"mayun"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查询链"><a href="#查询链" class="headerlink" title="查询链"></a>查询链</h3><p>我们可以重复以上操作几次 。</p>
<p>然后查看整个区块链信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X GET localhost:8080/blockchain | python -m json.tool</span><br></pre></td></tr></table></figure>
<p>你会看到蕾丝如下输出</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"blocks"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:19:01"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"1124aa2a5867abee8b9cc3a3f4051b6665f89e26"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">193</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">100</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"Felix"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"mayun"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">100</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"Felix"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"mayun"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:27:39"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"11bec5f7bf8226c62119adfbb03ad37d24267092"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">277</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"1124aa2a5867abee8b9cc3a3f4051b6665f89e26"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">100</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"Felix"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"mayun"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">100</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"Felix"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"mayun"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到Felix不停的向mayun转100块 ， 真不要脸 。</p>
<h3 id="节点以及解决冲突"><a href="#节点以及解决冲突" class="headerlink" title="节点以及解决冲突"></a>节点以及解决冲突</h3><p>区块链同时存在与多个主机上 ， 也就是说会有很多的block-chain-server运行 ， 而对于不同的运算会有多个解产生 ， 这就是冲突问题了 ， 那么我们看下冲突解决的过程吧</p>
<p>首先 ， 我们在8081端口同时开启一个服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vapor run serve --port=8081</span><br></pre></td></tr></table></figure>
<p>然后添加几个区块和交易 ， 因为我们要验证解决冲突 ， 所以应该比运行在8080端口上的区块多 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X POST localhost:8081/block | python -m json.tool</span><br></pre></td></tr></table></figure>
<p>重复几次操作 ， 最后看下8081伤的blockchain</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"blocks"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:35:15"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"1152cb1aac50abd803a4589f28c7e054db207e23"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">215</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:37:18"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"1127f8c712ae3205ccbab9788392bcd190b8b6b1"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">380</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"1152cb1aac50abd803a4589f28c7e054db207e23"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:37:39"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"11b5d293c3068081f1771f14f96a3e450f282171"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">64</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"1127f8c712ae3205ccbab9788392bcd190b8b6b1"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:37:45"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"11d97dfca7cc7a67c22b9df06017768fca0a193f"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">125</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"11b5d293c3068081f1771f14f96a3e450f282171"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:38:03"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"115a991bd5d2ebe6e232b421965ab852b97a4202"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">220</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"11d97dfca7cc7a67c22b9df06017768fca0a193f"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们要让8080知道有这么一个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X POST localhost:8080/node --data <span class="string">"address=localhost:8081"</span> | python -m json.tool</span><br></pre></td></tr></table></figure>
<p>我们会看到节点已经注册成功了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"address"</span>: <span class="string">"localhost:8081"</span>,</span><br><span class="line">    <span class="string">"id"</span>: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时我们让8080去主动解决冲突</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s -X POST localhost:8080/resolve | python -m json.tool</span><br></pre></td></tr></table></figure>
<p>再查看8080上的区块链 ， 发现已经被替换为较长的8081上的blocks了。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"blocks"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:35:15"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"1152cb1aac50abd803a4589f28c7e054db207e23"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">215</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:37:18"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"1127f8c712ae3205ccbab9788392bcd190b8b6b1"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">380</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"1152cb1aac50abd803a4589f28c7e054db207e23"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:37:39"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"11b5d293c3068081f1771f14f96a3e450f282171"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">64</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"1127f8c712ae3205ccbab9788392bcd190b8b6b1"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:37:45"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"11d97dfca7cc7a67c22b9df06017768fca0a193f"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">125</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"11b5d293c3068081f1771f14f96a3e450f282171"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"dateCreated"</span>: <span class="string">"2018-08-11 17:38:03"</span>,</span><br><span class="line">            <span class="attr">"hash"</span>: <span class="string">"115a991bd5d2ebe6e232b421965ab852b97a4202"</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="attr">"index"</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="attr">"message"</span>: <span class="string">"\u6b64\u533a\u5757\u5df2\u6dfb\u52a0\u81f3\u533a\u5757\u94fe"</span>,</span><br><span class="line">            <span class="attr">"nonce"</span>: <span class="number">220</span>,</span><br><span class="line">            <span class="attr">"previousHash"</span>: <span class="string">"11d97dfca7cc7a67c22b9df06017768fca0a193f"</span>,</span><br><span class="line">            <span class="attr">"transactions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"amount"</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">"from"</span>: <span class="string">"mayun"</span>,</span><br><span class="line">                    <span class="attr">"to"</span>: <span class="string">"Felix"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h1><p>可以看到大概区块链的设计还是比较有意思的 ， 细节部分请不要在意（比如sha1和prefix“11” 😄）</p>
<p>基本的介绍就到这里啦 ， 限于本人的水平可能会有错误请不要全信 。</p>
<p>打扰了 .</p>

      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/blockChain/">blockChain</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swift/">swift</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-cocoapod"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/07/25/cocoapod/">磨刀不误砍柴之cocoapods</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/07/25/cocoapod/" class="article-date">
	  <time datetime="2018-07-25T02:02:38.000Z" itemprop="datePublished">2018-07-25</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote>
<p>CocoaPods是OS X和iOS下的一个第三类库管理工具，通过CocoaPods工具我们可以为项目添加被称为“Pods”的依赖库（这些类库必须是CocoaPods本身所支持的），并且可以轻松管理其版本。</p>
</blockquote>
<p>CocoaPods意义体现在两个方面：</p>
<ul>
<li>第一，在引入第三方库时它可以自动为我们完成各种各样的配置，包括配置编译阶段、连接器选项、甚至是ARC环境下的-fno-objc-arc配置等。</li>
<li>第二，使用CocoaPods可以很方便地查找新的第三方库，这些类库是比较“标准的”，而不是网上随便找到的，这样可以让我们找到真正好用的类库。</li>
</ul>
<h1 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem install cocoapods</span><br></pre></td></tr></table></figure>
<h2 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod --version</span><br></pre></td></tr></table></figure>
<p>在开发中安装使用cocoapods要注意版本 ， 因为一般开发过程中要大家一起使用同一个工程 ，一般为了指定版本我们会在工程下存放一个Gemfile来指定使用cocoapods的版本 ， 这里不过多介绍 。</p>
<h2 id="指定版本"><a href="#指定版本" class="headerlink" title="指定版本"></a>指定版本</h2><p>除了指定Gemfile以外 ， 我们还可以安装指定版本的pods</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem install cocoapods -v 1.3.1</span><br></pre></td></tr></table></figure>
<p>再查看一下pod版本我们就会发现已经安装了1.3.1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod --version</span><br></pre></td></tr></table></figure>
<h2 id="卸载掉不需要的版本"><a href="#卸载掉不需要的版本" class="headerlink" title="卸载掉不需要的版本"></a>卸载掉不需要的版本</h2><p>当我们本地同时存在多个版本的pod的时候可以把多余的卸载掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem uninstall cocoapods</span><br></pre></td></tr></table></figure>
<p>会提示我们选择卸载的版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Select gem to uninstall:</span><br><span class="line"> 1. cocoapods-1.2.1</span><br><span class="line"> 2. cocoapods-1.3.1</span><br><span class="line"> 3. All versions</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>我们选择想要卸载的版本的序号就好了 。</p>
<h1 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h1><p>cocoapods支持我们去查找想要使用的仓库 , 比如我们想查找ReactoveObjC这个库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod spec cat ReactiveObjC</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"ReactiveObjC"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"3.1.0"</span>,</span><br><span class="line">  <span class="string">"summary"</span>: <span class="string">"The 2.x ReactiveCocoa Objective-C API: Streams of values over time"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">"ReactiveObjC (formally ReactiveCocoa or RAC) is an Objective-C\nframework inspired by [Functional Reactive Programming](\nhttp://en.wikipedia.org/wiki/Functional_reactive_programming).\nIt provides APIs for composing and **transforming streams of values**."</span>,</span><br><span class="line">  <span class="string">"homepage"</span>: <span class="string">"https://reactivecocoa.io"</span>,</span><br><span class="line">  <span class="string">"screenshots"</span>: <span class="string">"https://reactivecocoa.io/img/logo.png"</span>,</span><br><span class="line">  <span class="string">"license"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">    <span class="string">"file"</span>: <span class="string">"LICENSE.md"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"documentation_url"</span>: <span class="string">"https://github.com/ReactiveCocoa/ReactiveObjC/tree/master/Documentation#readme"</span>,</span><br><span class="line">  <span class="string">"authors"</span>: <span class="string">"ReactiveCocoa"</span>,</span><br><span class="line">  <span class="string">"social_media_url"</span>: <span class="string">"https://twitter.com/ReactiveCocoa"</span>,</span><br><span class="line">  <span class="string">"platforms"</span>: &#123;</span><br><span class="line">    <span class="string">"ios"</span>: <span class="string">"8.0"</span>,</span><br><span class="line">    <span class="string">"osx"</span>: <span class="string">"10.9"</span>,</span><br><span class="line">    <span class="string">"watchos"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"tvos"</span>: <span class="string">"9.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"source"</span>: &#123;</span><br><span class="line">    <span class="string">"git"</span>: <span class="string">"https://github.com/ReactiveCocoa/ReactiveObjC.git"</span>,</span><br><span class="line">    <span class="string">"tag"</span>: <span class="string">"3.1.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"source_files"</span>: [</span><br><span class="line">    <span class="string">"ReactiveObjC/*.&#123;h,m,d&#125;"</span>,</span><br><span class="line">    <span class="string">"ReactiveObjC/extobjc/*.&#123;h,m&#125;"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"private_header_files"</span>: [</span><br><span class="line">    <span class="string">"**/*Private.h"</span>,</span><br><span class="line">    <span class="string">"**/*EXTRuntimeExtensions.h"</span>,</span><br><span class="line">    <span class="string">"**/RACEmpty*.h"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"ios"</span>: &#123;</span><br><span class="line">    <span class="string">"exclude_files"</span>: <span class="string">"ReactiveObjC/**/*&#123;AppKit,NSControl,NSText,NSTable&#125;*"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"osx"</span>: &#123;</span><br><span class="line">    <span class="string">"exclude_files"</span>: <span class="string">"ReactiveObjC/**/*&#123;UIActionSheet,UIAlertView,UIBarButtonItem,UIButton,UICollectionReusableView,UIControl,UIDatePicker,UIGestureRecognizer,UIImagePicker,UIRefreshControl,UISegmentedControl,UISlider,UIStepper,UISwitch,UITableViewCell,UITableViewHeaderFooterView,UIText,MK&#125;*"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tvos"</span>: &#123;</span><br><span class="line">    <span class="string">"exclude_files"</span>: <span class="string">"ReactiveObjC/**/*&#123;AppKit,NSControl,NSText,NSTable,UIActionSheet,UIAlertView,UIDatePicker,UIImagePicker,UIRefreshControl,UISlider,UIStepper,UISwitch,MK&#125;*"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"watchos"</span>: &#123;</span><br><span class="line">    <span class="string">"exclude_files"</span>: <span class="string">"ReactiveObjC/**/*&#123;UIActionSheet,UIAlertView,UIBarButtonItem,UIButton,UICollectionReusableView,UIControl,UIDatePicker,UIGestureRecognizer,UIImagePicker,UIRefreshControl,UISegmentedControl,UISlider,UIStepper,UISwitch,UITableViewCell,UITableViewHeaderFooterView,UIText,MK,AppKit,NSControl,NSText,NSTable,NSURLConnection&#125;*"</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到一大堆有的没的信息 ， 包括该pod仓库的实际仓库的地址和一些base信息</p>
<h1 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h1><p>首先 ， 新建一个singlgViewApp ，然后在命令行进入该project目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod init</span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Uncomment the next line to define a global platform for your project</span></span><br><span class="line"><span class="comment"># platform :ios, '9.0'</span></span><br><span class="line"></span><br><span class="line">target <span class="string">'Test'</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># Uncomment the next line if you're using Swift or would like to use dynamic frameworks</span></span><br><span class="line">  <span class="comment"># use_frameworks!</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Pods for ocTest</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到cocoapods为我们生成了一个Podfile<br>platform表示这个工程安装的设备 ， 后面是系统最低版本<br>现在我们可以在里面添加一下刚才搜索的仓库</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Uncomment the next line to define a global platform for your project</span></span><br><span class="line">platform <span class="symbol">:ios</span>, <span class="string">'9.0'</span></span><br><span class="line"></span><br><span class="line">target <span class="string">'ocTest'</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># Uncomment the next line if you're using Swift or would like to use dynamic frameworks</span></span><br><span class="line">  <span class="comment"># use_frameworks!</span></span><br><span class="line">  pod <span class="string">'ReactiveObjC'</span></span><br><span class="line">  <span class="comment"># Pods for ocTest</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这里我们添加了一个仓库 ，接下来再命令行执行pod update来安装所需要的仓库 ， 安装完毕后我们可以看到当前路径下有两个工程文件 </p>
<ul>
<li>Test.xcodeproj</li>
<li>Test.xcworkspace</li>
</ul>
<p>我们在使用了cocoapods管理第三方库的时候 ， 每次install或者update的时候就会生成*.xcworkspace这个文件 ， 我们就用这个工程开发调试就好了 。</p>
<p>现在打开工程 ， 定位到viewController.m中就可以引用并使用ReactiveObjC啦 。</p>
<h1 id="使用私有源"><a href="#使用私有源" class="headerlink" title="使用私有源"></a>使用私有源</h1><p>公司内部有自己搭建的gitlab服务时 ， 有的公司搭建的gitlab服务为了安全并没有提供外网接口 ， 我们只能在内网访问 ， 这时候就要在podfile中添加私有源的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> <span class="string">'http://xx.xxxx.com/ios/cocoapods-spec.git'</span></span><br><span class="line"><span class="built_in">source</span> <span class="string">'https://github.com/CocoaPods/Specs.git'</span>  <span class="comment"># 官方库</span></span><br></pre></td></tr></table></figure>
<p>上面那个就是我们要添加的私有源地址 ， 下面的是官方源地址 ，如果都不写的话那么默认就会使用官方源 。</p>
<h1 id="发布自己的pod"><a href="#发布自己的pod" class="headerlink" title="发布自己的pod"></a>发布自己的pod</h1><p>发布pod分为发布到官方源和发布到私有源 , 这里暂不表发布到官方源 。<br>重点来讲一下发布到私有源 。</p>
<h2 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod lib create TDFCommonUtil</span><br></pre></td></tr></table></figure>
<p>pod会给出一些选项让我们选择</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">To get you started we need to ask a few questions, this should only take a minute.</span><br><span class="line"></span><br><span class="line">If this is your first time we recommend running through with the guide:</span><br><span class="line"> - https://guides.cocoapods.org/making/using-pod-lib-create.html</span><br><span class="line"> ( hold cmd and click links to open <span class="keyword">in</span> a browser. )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">What platform <span class="keyword">do</span> you want to use?? [ iOS / macOS ]</span><br><span class="line"> &gt;</span><br><span class="line">ios</span><br><span class="line">What language <span class="keyword">do</span> you want to use?? [ Swift / ObjC ]</span><br><span class="line"> &gt;</span><br><span class="line">swift</span><br><span class="line">Would you like to include a demo application with your library? [ Yes / No ]</span><br><span class="line"> &gt;</span><br><span class="line">yes</span><br><span class="line">Which testing frameworks will you use? [ Quick / None ]</span><br><span class="line"> &gt; None</span><br><span class="line"></span><br><span class="line">Would you like to <span class="keyword">do</span> view based testing? [ Yes / No ]</span><br><span class="line"> &gt; NO</span><br></pre></td></tr></table></figure>
<p>都填写完后会自动打开一个工程 。</p>
<h2 id="添加基本信息"><a href="#添加基本信息" class="headerlink" title="添加基本信息"></a>添加基本信息</h2><p>cd进入刚才创建的目录 执行命令 ls </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Example               README.md           TDFCommonUtil.podspec</span><br><span class="line">LICENSE               TDFCommonUtil         _Pods.xcodeproj</span><br></pre></td></tr></table></figure>
<p>解释一下这里都是啥</p>
<ul>
<li>Example 这里面就是示例工程</li>
<li>README.md 这里面是我们对改pod功能和使用等的介绍 ， 使用markdown语法</li>
<li>TDFCommonUtil.podspec 这里是改模块的全部基本信息</li>
<li>LICENSE 这里放的是改开源项目遵守的协议</li>
<li>TDFCommonUtil 这里放着全部的类文件和资源文件</li>
<li>_Pods.xcodeproj 这是示例工程的快捷方式</li>
</ul>
<p>我们首先要为我们的pod创建一个实际的git仓库 。</p>
<p>打开gitlab服务创建一个空的git仓库 然后先把pod目录提交到我们的仓库 blalblabla</p>
<p>打开TDFCommonUtil.podspec文件</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Pod::Spec.new <span class="keyword">do</span> <span class="params">|s|</span></span><br><span class="line">  s.name             = <span class="string">'TDFCommonUtil'</span></span><br><span class="line">  s.version          = <span class="string">'0.1.0'</span></span><br><span class="line">  s.summary          = <span class="string">'A short description of TDFCommonUtil.'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  s.description      = <span class="string">&lt;&lt;-DESC</span></span><br><span class="line"><span class="string">TODO: Add long description of the pod here.</span></span><br><span class="line"><span class="string">                       DESC</span></span><br><span class="line"></span><br><span class="line">  s.homepage         = <span class="string">'https://github.com/xxxxx@yeah.net/TDFCommonUtil'</span></span><br><span class="line">  s.license          = &#123; <span class="symbol">:type</span> =&gt; <span class="string">'MIT'</span>, <span class="symbol">:file</span> =&gt; <span class="string">'LICENSE'</span> &#125;</span><br><span class="line">  s.author           = &#123; <span class="string">'xxxxx'</span> =&gt; <span class="string">'xxxxx@2dfire.com'</span> &#125;</span><br><span class="line">  s.source           = &#123; <span class="symbol">:git</span> =&gt; <span class="string">'https://github.com/xxxxx@yeah.net/TDFCommonUtil.git'</span>, <span class="symbol">:tag</span> =&gt; s.version.to_s &#125;</span><br><span class="line"></span><br><span class="line">  s.ios.deployment_target = <span class="string">'8.0'</span></span><br><span class="line"></span><br><span class="line">  s.source_files = <span class="string">'TDFCommonUtil/Classes/**/*'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># s.resource_bundles = &#123;</span></span><br><span class="line">  <span class="comment">#   'TDFCommonUtil' =&gt; ['TDFCommonUtil/Assets/*.png']</span></span><br><span class="line">  <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># s.public_header_files = 'Pod/Classes/**/*.h'</span></span><br><span class="line">  <span class="comment"># s.frameworks = 'UIKit', 'MapKit'</span></span><br><span class="line">  <span class="comment"># s.dependency 'AFNetworking', '~&gt; 2.3'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这里的配置项就是生成pod需要配置的大部分选项了 ，简单介绍一下</p>
<ul>
<li>name pod名称</li>
<li>version 版本号 ，特别注意下在更新时需要对git仓库打tag</li>
<li>summary 简介</li>
<li>description 描述</li>
<li>homepage 主页</li>
<li>license 使用协议</li>
<li>author 作者</li>
<li>deployment_target 需要系统版本</li>
<li>source_files 源文件路径</li>
<li>resource_bundles 资源文件路径 注意这里会把资源文件打包成bundle ， 调用的时候要注意下</li>
<li>public_header_files 公开的头文件 （有些头文件我们不想要外部看见可以在这里去掉）</li>
<li>frameworks 需要依赖的framework库</li>
<li>dependency 需要依赖的其他pod</li>
</ul>
<p>现在把这些填好吧 。</p>
<h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><p>有的时候我们开发的pod仓库需要依赖其他仓库 ， 比如我们需要依赖ReactiveObjC<br>这里就可以在TDFCommonUtil.podspec下面添加这一行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.dependency <span class="string">'ReactiveObjC'</span></span><br></pre></td></tr></table></figure>
<p>ps ，这里可以指向特定的版本也可以用 ‘~&gt; 2.3’ 的形式表示依赖此仓库至少大于2.3版本但是不会超过3.0 。</p>
<h2 id="lint检测"><a href="#lint检测" class="headerlink" title="lint检测"></a>lint检测</h2><p>一切就绪后你可以在里面创建你的文件 ， 添加代码了 ，别忘了再有文件的增加或删除后在运行一遍 ‘pod install’ 哦 。</p>
<p>先随便创建几个文件 ， 保证编译不报错就可以了 ，然后我们使用cocoapods检测我们的库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod lib lint --sources=<span class="string">'git@git.xxx.com:ios/cocoapods-spec.git'</span> --use-libraries --allow-warnings --verbose --no-clean</span><br></pre></td></tr></table></figure>
<p>这里的sources填写你所使用的私有gitlab服务 ，然后我们就可以静静的看着命令行了 。</p>
<p>最后会出现</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Test passed validation.</span><br></pre></td></tr></table></figure>
<p>证明你的库是可运行的 ， 如果没有出现passed就注意下输出中的error信息 ，看下是什么导致的 。</p>
<h2 id="向私有源推送"><a href="#向私有源推送" class="headerlink" title="向私有源推送"></a>向私有源推送</h2><p>lint通过后我们就可以把自己的仓库信息推送到私有源了 ， 注意不是「仓库」是「仓库信息」，也就是x.podspec 。<br>cocoapod可以自动帮我们完成这件事情</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod repo push xxx-cocoapods-spec TDFOpenShopSDK.podspec --sources=git@git.xxx.com:ios/cocoapods-spec.git --allow-warnings --use-libraries --verbose</span><br></pre></td></tr></table></figure>
<p>把命令中的xxx替换为你的私有源和仓库就可以了 。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以上基本是我们工作中常用的cocoapods的方法了 ， 还有一些动态静态库依赖的问题暂时不做总结 ， 后续再谈谈自己遇到过的坑 ， 比上面这些加起来还要精彩哦 ，欢迎email讨论</p>
<pre><code class="bash">
</code></pre>

      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cocoapods/">cocoapods</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-NSCache"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/07/25/NSCache/">NSCache</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/07/25/NSCache/" class="article-date">
	  <time datetime="2018-07-25T02:01:56.000Z" itemprop="datePublished">2018-07-25</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h1><blockquote>
<p>NSCache 基本上就是一个会自动移除对象来释放内存的 NSMutableDictionary。无需响应内存警告或者使用计时器来清除缓存。唯一的不同之处是键对象不会像 NSMutableDictionary 中那样被复制，这实际上是它的一个优点（键不需要实现 NSCopying 协议）。</p>
</blockquote>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul>
<li>NSCache是一个类似NSDictionary一个可变的集合。</li>
<li>提供了可设置缓存的数目与内存大小限制的方式。</li>
<li>保证了处理的数据的线程安全性。</li>
<li>缓存使用的key不需要是实现NSCopying的类。</li>
<li>当内存警告时内部自动清理部分缓存数据。</li>
</ul>
<h2 id="属性与方法"><a href="#属性与方法" class="headerlink" title="属性与方法"></a>属性与方法</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>) <span class="keyword">id</span>&lt;<span class="built_in">NSCacheDelegate</span>&gt;delegate;</span><br></pre></td></tr></table></figure>
<p>cache对象的代理 ， 用来即将清理cache的时候得到通知</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)cache:(<span class="built_in">NSCache</span> *)cache willEvictObject:(<span class="keyword">id</span>)obj;</span><br></pre></td></tr></table></figure>
<p>代理方法 ， 这里面不要对cache进行改动 ， 如果对象obj需要被持久化存储的话可以在这里进行操作</p>
<p>这里面有几种情况会导致该方法执行：</p>
<ul>
<li>手动移除（removeObjectForKey）</li>
<li>缓存超过设定的上线</li>
<li>App不活跃</li>
<li>系统内存爆炸</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> <span class="built_in">BOOL</span> evictsObjectsWithDiscardedContent;</span><br></pre></td></tr></table></figure>
<p>该属性默认为True ， 表示在内存销毁时丢弃该对象 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> <span class="built_in">NSUInteger</span> totalCostLimit;</span><br></pre></td></tr></table></figure>
<p>总成本数 ， 用来设置最大缓存数量</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  TDFSetPhoneNumController.m</span></span><br><span class="line"><span class="comment">//  TDFLoginModule</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by doubanjiang on 2017/6/5.</span></span><br><span class="line"><span class="comment">//  Copyright © 2017年 doubanjiang. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"viewController.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">viewController</span> () &lt;<span class="title">NSCacheDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span> ,<span class="keyword">strong</span>) <span class="built_in">NSCache</span> *cache;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">viewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> beginCache];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)beginCache &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *obj = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"object--%d"</span>,i];</span><br><span class="line">        [<span class="keyword">self</span>.cache setObject:obj forKey:@(i) cost:<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ cached"</span>,obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSCacheDelegate</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)cache:(<span class="built_in">NSCache</span> *)cache willEvictObject:(<span class="keyword">id</span>)obj &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//evict : 驱逐</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ will be evict"</span>,obj]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Getter</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSCache</span> *)cache &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_cache) &#123;</span><br><span class="line">        _cache = [<span class="built_in">NSCache</span> new];</span><br><span class="line">        _cache.totalCostLimit = <span class="number">5</span>;</span><br><span class="line">        _cache.delegate = <span class="keyword">self</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _cache;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>我们会看到以下输出</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.485719</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-0</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.485904</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-1</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486024</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-2</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486113</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-3</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486254</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-4</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486382</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-0</span> will be evict</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486480</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-5</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486598</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-1</span> will be evict</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486681</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-6</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486795</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-2</span> will be evict</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486888</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-7</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.486995</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-3</span> will be evict</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.487190</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-8</span> cached</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.487446</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-4</span> will be evict</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-31</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">56.487604</span>+<span class="number">0800</span> Test_Example[<span class="number">52839</span>:<span class="number">214698</span>] object-<span class="number">-9</span> cached</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>经过实验我们发现NSCache使用上性价比还是比较高的 ， 比一些瞎折腾出来的缓存好用很多 。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NSCache/">NSCache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-rxswift"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/07/24/rxswift/">RxSwift</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/07/24/rxswift/" class="article-date">
	  <time datetime="2018-07-24T06:32:19.000Z" itemprop="datePublished">2018-07-24</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h1><blockquote>
<p>RxSwift 是在 Apple 推出 Swift 后， ReactiveX 推出 Reactive Extensions 系列一个实现库。但是学习 RxSwift 不是学习如何使用第三方库，而是学习一个思想。</p>
</blockquote>
<h2 id="编程范式"><a href="#编程范式" class="headerlink" title="编程范式"></a>编程范式</h2><blockquote>
<p>编程范型、编程范式或程序设计法（英语：Programming paradigm），（范即模范、典范之意，范式即模式、方法），是一类典型的编程风格，是指从事软件工程的一类典型的风格（可以对照方法学）。如：函数式编程、程序编程、面向对象编程、指令式编程等等为不同的编程范型。<br>编程范型提供了（同时决定了）程序员对程序执行的看法。例如，在面向对象编程中，程序员认为程序是一系列相互作用的对象，而在函数式编程中一个程序会被看作是一个无状态的函数计算的序列。</p>
</blockquote>
<h2 id="函数式"><a href="#函数式" class="headerlink" title="函数式"></a>函数式</h2><blockquote>
<p>简单说，”函数式编程”是一种”编程范式”（programming paradigm），也就是如何编写程序的方法论。它属于”结构化编程”的一种，主要思想是把运算过程尽量写成一系列嵌套的函数调用。</p>
</blockquote>
<h2 id="响应式"><a href="#响应式" class="headerlink" title="响应式"></a>响应式</h2><blockquote>
<p>在计算机中，响应式编程或反应式编程（英语：Reactive programming）是一种面向数据流和变化传播的编程范式。这意味着可以在编程语言中很方便地表达静态或动态的数据流，而相关的计算模型会自动将变化的值通过数据流进行传播。</p>
</blockquote>
<h1 id="RxSwift核心"><a href="#RxSwift核心" class="headerlink" title="RxSwift核心"></a>RxSwift核心</h1><ul>
<li>Observable    可观测序列</li>
<li>Observer      观察者</li>
<li>Operator      创建变化组合事件</li>
<li>Disposable    管理订阅生命周期</li>
<li>Schedulers    线程队列</li>
</ul>
<h2 id="Observable"><a href="#Observable" class="headerlink" title="Observable"></a>Observable</h2><p>简单来说 ， Observable即使可被观察的序列 ， 就像数组一样：[1,2,3,4,5]</p>
<p>而我对Observable的理解则是加上了时间维度的数组 ， 这个数组会随着时间的变化而变化 。</p>
<p>在这里你可以想象一下温度的变化 : [35,35.1,35.4,38,爆炸]<br>               海平面的升高 : [海拔100m，海拔110m，海拔112m]<br>大概这样理解比较直观 。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> numbers: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; = <span class="type">Observable</span>.create &#123; observer -&gt; <span class="type">Disposable</span> <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            observer.onNext(<span class="number">0</span>)</span><br><span class="line">            observer.onNext(<span class="number">1</span>)</span><br><span class="line">            observer.onNext(<span class="number">2</span>)</span><br><span class="line">            observer.onNext(<span class="number">3</span>)</span><br><span class="line">            observer.onNext(<span class="number">4</span>)</span><br><span class="line">            observer.onNext(<span class="number">5</span>)</span><br><span class="line">            observer.onNext(<span class="number">6</span>)</span><br><span class="line">            observer.onNext(<span class="number">7</span>)</span><br><span class="line">            observer.onNext(<span class="number">8</span>)</span><br><span class="line">            observer.onNext(<span class="number">9</span>)</span><br><span class="line">            observer.onCompleted()</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="number">_</span> = numbers.takeUntil(<span class="keyword">self</span>.rx.deallocated).subscribe(onNext: &#123; a <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(a)</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h2><p>Observer 是一个订阅者 ， 它可以观察「可被观察序列」的变化</p>
<h3 id="AnyObserver"><a href="#AnyObserver" class="headerlink" title="AnyObserver"></a>AnyObserver</h3><h3 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h3><h2 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h2><h2 id="Disposable"><a href="#Disposable" class="headerlink" title="Disposable"></a>Disposable</h2><h2 id="Schedulers"><a href="#Schedulers" class="headerlink" title="Schedulers"></a>Schedulers</h2><h1 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h1><h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1>
      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swift/">swift</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-aop"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/07/24/aop/">AOP</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/07/24/aop/" class="article-date">
	  <time datetime="2018-07-24T06:32:12.000Z" itemprop="datePublished">2018-07-24</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Aspect-Oriented-Programming"><a href="#Aspect-Oriented-Programming" class="headerlink" title="Aspect Oriented Programming"></a>Aspect Oriented Programming</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>AOP 直译为 （面向切面编程）</p>
<p>以下引用自wikipedia</p>
<blockquote>
<p>面向侧面的程序设计（aspect-oriented programming，AOP，又译作面向方面的程序设计、观点导向编程、剖面导向程序设计）是计算机科学中的一个术语，指一种程序设计范型。该范型以一种称为侧面（aspect，又译作方面）的语言构造为基础，侧面是一种新的模块化机制，用来描述分散在对象、类或函数中的横切关注点（crosscutting concern）。侧面的概念源于对面向对象的程序设计的改进，但并不只限于此，它还可以用来改进传统的函数。与侧面相关的编程概念还包括元对象协议、主题（subject）、混入（mixin）和委托。</p>
</blockquote>
<h3 id="面向对象-OOP"><a href="#面向对象-OOP" class="headerlink" title="面向对象(OOP)"></a>面向对象(OOP)</h3><p>我们都知道面向对象的三大特点是：</p>
<ul>
<li>继承</li>
<li>封装</li>
<li>多态</li>
</ul>
<p>其中 ， 分装的要求是将功能分散到不同的类中 ， 执行职责划分 ， 这样就降低了代码的复杂度 ， 同时也让类和对象更易读易懂 。<br>但是有的时候几个不同的类可能会需要执行相同的方法 ， 比如在页面跳转的时候进行埋点记录 、 将当前页面的标识发送给服务端记录 。<br>这里你可能会想 ，写个类把这块代码封装一下 ， 再在需要的地方调用不就可以了 。<br>想一下 ， 当我们这个方法调用的api需要改写的时候会怎么样呢 ， 所有之前的调用处都需要改写 。<br>AOP就是为了这种情况而生的 ， 有了它我们可以把需要执行的代码切入到特定的类的指定位置（方法）中 。</p>
<blockquote>
<p>一般我们把这段需要执行的代码叫做切面 , 这组代码中的一份叫做切片 , 切入的位置叫做切入点 。</p>
</blockquote>
<p>这样看来 ， 有了AOP ， 我们的OOP就更加立体了 ， 我们可以在不修改源代码的前提下实现统一的某种需要执行的操作 。</p>
<h2 id="iOS中的应用"><a href="#iOS中的应用" class="headerlink" title="iOS中的应用"></a>iOS中的应用</h2><p>对于我们iOS程序员来说 ， 我们在App中应用AOP最好的方式是通过runtime的methodswizzing ， runtime是一个比较难用的库 ， 因为比较底层 ，这里介绍一下Aspects这个库 ， 可以让我们方便的进行方法交换</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>这里我们使用cocoapod管理三方库</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="string">"Aspects"</span></span><br></pre></td></tr></table></figure>
<h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><p>首先创建一个工程 ， 安装Aspects ， 然后在appdelegate中的代理方法中添加如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIViewController</span> aspect_hookSelector:<span class="keyword">@selector</span>(viewWillAppear:) withOptions:AspectPositionAfter usingBlock:^(<span class="keyword">id</span>&lt;AspectInfo&gt; aspectInfo, <span class="built_in">BOOL</span> animated) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"View Controller %@ will appear animated: %tu"</span>, aspectInfo.instance, animated);</span><br><span class="line">&#125; error:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>
<p>这样 ，我们就hook了UIViewController的viewWillAppear方法 ， 可以在这里插入切片了</p>
<h2 id="源代码解读"><a href="#源代码解读" class="headerlink" title="源代码解读"></a>源代码解读</h2><p>pass</p>

      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AOP/">AOP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-unitTest"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/06/10/unitTest/">iOS UnitTest XCTest 使用小结</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/06/10/unitTest/" class="article-date">
	  <time datetime="2018-06-10T11:33:49.000Z" itemprop="datePublished">2018-06-10</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="UT"><a href="#UT" class="headerlink" title="UT"></a>UT</h1><p>在开发或是维护一些功能的时候，往往我们自以为是的没问题，全弄好了，根本不会出问题（微笑for me）<br>是根本靠不住的，这时候就需要我们掏出单元测试撸一遍，如果没问题再去让测试大大帮我们把关，<br>今天就谈一下iOS测试类XCTest。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>工具类，和我们的一些外部扩展的方法稳定性</li>
<li>性能测试</li>
<li>网络接口测试</li>
</ul>
<h2 id="方法介绍"><a href="#方法介绍" class="headerlink" title="方法介绍"></a>方法介绍</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setUp &#123;</span><br><span class="line">    [<span class="keyword">super</span> setUp];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当测试执行之前要做的是，相当于可以把所有的初始化工作放在这里</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)tearDown &#123;</span><br><span class="line">    [<span class="keyword">super</span> tearDown];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当测试执行完后要做的事</p>
<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><ol>
<li>首先，在你要测试的project中新建一个Test target</li>
<li>新建一个类，继承 XCTestCase</li>
<li>现在，我们就可以写测试代码啦</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TDFTestCase</span></span></span><br><span class="line">- (<span class="keyword">void</span>)setUp &#123;</span><br><span class="line">    [<span class="keyword">super</span> setUp];</span><br><span class="line">    <span class="comment">// 设置bundleVersion</span></span><br><span class="line">    [[[<span class="built_in">NSBundle</span> mainBundle]infoDictionary]setValue:<span class="string">@"5660"</span> forKey:<span class="string">@"CFBundleShortVersionString"</span>];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)tearDown &#123;</span><br><span class="line">    <span class="comment">// Put teardown code here. This method is called after the invocation of each test method in the class.</span></span><br><span class="line">    [<span class="keyword">super</span> tearDown];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testHTTPDNSPOD &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>在测试类中，每一个以test开头的方法都是一个测试方法，下面来让我们几个试一下吧</p>
<p>假设有这样一个类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FXCalculator</span></span></span><br><span class="line">+ (<span class="built_in">NSInteger</span>)zero &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>这个类有一个类方法，作用也很简单，就是返回一个0，我们要写一个测试方法，来证明返回值确实是0<br>下面，我们在TDFTestCase.m文件的implementation中写这样一个测试方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testThatCalculateZeroCorrect</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">XCTAssert</span>(<span class="number">0</span>==[FXCalculator zero]);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简单，XCTAssert接收一个条件，当条件满足时，测试通过<br>你会发现函数左边出现一个菱形按钮，我们点击这个按钮，biu～<br>Test Success</p>
<p>但是这只是测试一个方法，当我们想要测试一组方法的时候呢</p>
<pre><code>添加一个方法到FXCalculator中
</code></pre><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSInteger</span>)one &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再添加一个测试方法到TDFTestCase.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSInteger</span>)one &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TDFTestCase</span></span></span><br></pre></td></tr></table></figure>
<p>左边的菱形按钮，这些方法就会依次执行下去</p>
<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>现在我们先添加一个函数，这是一个阶乘函数，递归调用自身</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSInteger</span>)factorial:(<span class="built_in">NSInteger</span> )i &#123;</span><br><span class="line">    <span class="keyword">if</span> (!i) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i*[<span class="keyword">self</span> factorial:i<span class="number">-1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来一个测试函数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testThatCalculateFactorial</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSInteger</span> i = [FXCalculator factorial:<span class="number">4</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">XCTAssert</span>(i == <span class="number">24</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4的阶乘是24，现在我们测试成功，那我们想测试以下阶乘方法的性能怎么办呢</p>
<p>只要使用XCTest提供给我们的一个block就可以啦</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testThatCalculateFactorial</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> measureBlock:^&#123;</span><br><span class="line">        [FXCalculator factorial:<span class="number">100</span>];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击开始测试，完成后你会看到measureBlock这一行的左面出现一个灰色的按钮，点按就可以看到该方法的性能测试啦<br>选中Baseline，可以设置性能的基线，也就是合格线</p>
<h2 id="异步测试"><a href="#异步测试" class="headerlink" title="异步测试"></a>异步测试</h2><p>有时候我们相对网络请求进行测试，如何测试异步方法呢<br>比如我前一段时间改造网络框架，担心自己哪里写出了问题，跑去找boss商量，经过boss的提醒我决定先搞几个接口测试出来<br>这样不论我怎么改造，因为不涉及外部调用，所以只要测试全部通过就说明没啥问题<br>那么接口测试咋写呢</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testThatLoginWithParamsNull &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成expection</span></span><br><span class="line">    <span class="built_in">XCTestExpectation</span> *expection = [<span class="keyword">self</span> expectationWithDescription:<span class="string">@"login request"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送请求</span></span><br><span class="line">    TDFRequest *req = [<span class="keyword">self</span> loginRequestModelInBossApi];</span><br><span class="line">    [[<span class="keyword">self</span> client] sendRequestWithRequestModel:req progress:<span class="literal">nil</span> callback:^(TDFResponse * _Nullable res) &#123;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//表示条件满足，测试可以执行</span></span><br><span class="line">        [expection fulfill];</span><br><span class="line">        <span class="built_in">XCTAssertNotNil</span>(res.responseObject);</span><br><span class="line">        <span class="built_in">XCTAssertEqual</span>(res.responseObject[<span class="string">@"code"</span>], [<span class="built_in">NSNumber</span> numberWithInteger:<span class="number">0</span>]);</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待异步任务超时</span></span><br><span class="line">    [<span class="keyword">self</span> waitForExpectationsWithTimeout:<span class="keyword">self</span>.networkTimeout handler:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="built_in">XCTFail</span>(<span class="string">"Time out"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试断言命令"><a href="#测试断言命令" class="headerlink" title="测试断言命令"></a>测试断言命令</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">XCTFail</span>(format…) 生成一个失败的测试；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertNil</span>(a1, format...)为空判断，a1为空时通过，反之不通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertNotNil</span>(a1, format…)不为空判断，a1不为空时通过，反之不通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssert</span>(expression, format...)当expression求值为<span class="literal">TRUE</span>时通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertTrue</span>(expression, format...)当expression求值为<span class="literal">TRUE</span>时通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertFalse</span>(expression, format...)当expression求值为False时通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertEqualObjects</span>(a1, a2, format...)判断相等，[a1 isEqual:a2]值为<span class="literal">TRUE</span>时通过，其中一个不为空时，不通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertNotEqualObjects</span>(a1, a2, format...)判断不等，[a1 isEqual:a2]值为False时通过，</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertEqual</span>(a1, a2, format...)判断相等（当a1和a2是 C语言标量、结构体或联合体时使用,实际测试发现<span class="built_in">NSString</span>也可以）；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertNotEqual</span>(a1, a2, format...)判断不等（当a1和a2是 C语言标量、结构体或联合体时使用）；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertEqualWithAccuracy</span>(a1, a2, accuracy, format...)判断相等，（<span class="keyword">double</span>或<span class="keyword">float</span>类型）提供一个误差范围，当在误差范围（+/-accuracy）以内相等时通过测试；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertNotEqualWithAccuracy</span>(a1, a2, accuracy, format...) 判断不等，（<span class="keyword">double</span>或<span class="keyword">float</span>类型）提供一个误差范围，当在误差范围以内不等时通过测试；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertThrows</span>(expression, format...)异常测试，当expression发生异常时通过；反之不通过；（很变态）</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertThrowsSpecific</span>(expression, specificException, format...) 异常测试，当expression发生specificException异常时通过；反之发生其他异常或不发生异常均不通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertThrowsSpecificNamed</span>(expression, specificException, exception_name, format...)异常测试，当expression发生具体异常、具体异常名称的异常时通过测试，反之不通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertNoThrow</span>(expression, format…)异常测试，当expression没有发生异常时通过测试；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertNoThrowSpecific</span>(expression, specificException, format...)异常测试，当expression没有发生具体异常、具体异常名称的异常时通过测试，反之不通过；</span><br><span class="line"></span><br><span class="line"><span class="built_in">XCTAssertNoThrowSpecificNamed</span>(expression, specificException, exception_name, format...)异常测试，当expression没有发生具体异常、具体异常名称的异常时通过测试，反之不通过.</span><br></pre></td></tr></table></figure>
<p>单元测试就先总结到这里，欢迎email讨论</p>

      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XCTest/">XCTest</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-methodcall"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/06/10/methodcall/">浅谈Objc的call method</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/06/10/methodcall/" class="article-date">
	  <time datetime="2018-06-10T10:53:47.000Z" itemprop="datePublished">2018-06-10</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>在OC中，我们一般都会写出这样的代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[SomeObj someMethod]</span><br></pre></td></tr></table></figure>
<p>实际上这些调用都会转化为 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSend(receiver, <span class="keyword">@selector</span>(message));</span><br></pre></td></tr></table></figure>
<p>这样的形式</p>
<p>那么。这一切中间经历了怎样的过程呢，下面我们先介绍几个名词</p>
<h2 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h2><blockquote>
<p>我们写的OC代码，在编译阶段会对所有方法生成一个ID，用来区分不同的方法，同时只要是是相同的函数名称，这个ID是相同的</p>
</blockquote>
<h2 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h2><blockquote>
<p>是一个函数指针，指向的是函数的实现首地址。在对象执行method的时候一般会先从方法列表里面查找相应的方法，如果我们直接使用IMP执行方法的话会省略这中间的很多步骤</p>
</blockquote>
<h2 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h2><blockquote>
<p>Method = SEL + IMP + method_types</p>
</blockquote>
<p>下面来直接看看方法调用流程吧</p>
<ol>
<li>检查方法是否需要忽略</li>
<li>检查target是否为nil，如果为nil直接clean并return</li>
<li>根据target的class去寻找IMP并执行</li>
</ol>
<p>寻找IMP过程</p>
<ol>
<li>先从target class 的cache methodLists（方法缓存列表）查找</li>
<li>如果缓存列表没有，直接查找方法列表，找到了添加进方法缓存列表并执行</li>
<li>递归查找superClass</li>
<li>如果都没找到进入动态转发<a href="https://www.jianshu.com/p/5127ce0628be" target="_blank" rel="noopener">resolveInstanceMethod</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-weak"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/06/10/weak/">浅谈Objective-C中的weak</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/06/10/weak/" class="article-date">
	  <time datetime="2018-06-10T08:47:24.000Z" itemprop="datePublished">2018-06-10</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>日常开发中我们使用weak大部分是为了修饰属性引用计数，防止循环引用、内存泄漏的作用，<br>那么他的原理是什么呢，</p>
<h1 id="原理简介"><a href="#原理简介" class="headerlink" title="原理简介"></a>原理简介</h1><blockquote>
<p>Runtime维护了一个weak表，用于存储指向某个对象的所有weak指针。weak表其实是一个hash（哈希）表，Key是所指对象的地址，Value是weak指针的地址（这个地址的值是所指对象的地址）数组。</p>
</blockquote>
<ol>
<li><p>初始化时：runtime会调用objc_initWeak函数，初始化一个新的weak指针指向对象的地址。</p>
</li>
<li><p>添加引用时：objc_initWeak函数会调用 objc_storeWeak() 函数， objc_storeWeak() 的作用是更新指针指向，创建对应的弱引用表。</p>
</li>
<li><p>释放时，调用clearDeallocating函数。clearDeallocating函数首先根据对象地址获取所有weak指针地址的数组，然后遍历这个数组把其中的数据设为nil，最后把这个entry从weak表中删除，最后清理对象的记录。</p>
</li>
</ol>
<p>当我们初始化一个weak变量时，runtime会调用 NSObject.mm 中的objc_initWeak函数。</p>
<p>添加引用时：objc_initWeak函数会调用 objc_storeWeak() 函数， objc_storeWeak() 的作用是更新指针指向，创建对应的弱引用表。</p>
<p>weak表是一个弱引用表，实现为一个weak_table_t结构体，存储了某个对象相关的的所有的弱引用信息。</p>
<h1 id="当销毁weak时又做了些什么呢"><a href="#当销毁weak时又做了些什么呢" class="headerlink" title="当销毁weak时又做了些什么呢"></a>当销毁weak时又做了些什么呢</h1><ol>
<li><p>调用objc_release</p>
</li>
<li><p>因为对象的引用计数为0，所以执行dealloc</p>
</li>
<li><p>在dealloc中，调用了_objc_rootDealloc函数</p>
</li>
<li><p>在_objc_rootDealloc中，调用了object_dispose函数</p>
</li>
<li><p>调用objc_destructInstance</p>
</li>
<li><p>最后调用objc_clear_deallocating</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-local"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/06/10/local/">iOS国际化小结</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/06/10/local/" class="article-date">
	  <time datetime="2018-06-10T08:46:56.000Z" itemprop="datePublished">2018-06-10</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>随着项目产品的发展，我们就需要适配多种国际化和地区，但是外国人还有一些不认识中文，我们又不能强迫他们去学习是吧<br>所以我们需要对自己的产品进行国际化，让更多的人了解我们的APP，这就需要对我们的产品进行国际化了<br>今天就介绍一下自己在国家化项目里面踩过的坑</p>
<h1 id="主工程内配置"><a href="#主工程内配置" class="headerlink" title="主工程内配置"></a>主工程内配置</h1><h2 id="配置project"><a href="#配置project" class="headerlink" title="配置project"></a>配置project</h2><ul>
<li>打开你的工程 ， 在左侧栏选中project</li>
<li>在打开的面板中选中project下的蓝色图标</li>
<li>找到Localizations选项 ， 添加你需要国家化的语言</li>
<li>在主工程下command + N 新建Localizable.string文件</li>
<li>选中你创建的string文件 ， 打开右侧面板</li>
<li>点击Localization组下的Localize按钮</li>
<li>把你刚才配置在工程内的选项添加进去就好。</li>
</ul>
<h2 id="调用方式"><a href="#调用方式" class="headerlink" title="调用方式"></a>调用方式</h2><p>在以前调用的地方我们需要替换为本地化调用方式</p>
<p>比如以前我们是这么调用的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *tips = <span class="string">@"wait"</span>;</span><br></pre></td></tr></table></figure>
<p>那么现在要换成</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *tips = <span class="built_in">NSLocalizedString</span>(<span class="string">@"wait"</span>, <span class="string">@"some tips to tell user wait"</span>);</span><br></pre></td></tr></table></figure>
<p>至于后面那段是为了方便翻译人员理解上下文语境使用的 。</p>
<p>然后在stirng文件内添加对应的字符串：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"wait"</span> = <span class="string">"别着急"</span>;</span><br></pre></td></tr></table></figure>
<p>这是对应中文的 ， 你可以在不同的文件添加对应不同语言的翻译 。</p>
<p>让我们看下这个宏的定义 ：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define NSLocalizedString(key, comment) \</span></span><br><span class="line">    [<span class="built_in">NSBundle</span>.mainBundle localizedStringForKey:(key) value:<span class="string">@""</span> table:<span class="literal">nil</span>]</span><br><span class="line"><span class="meta">#define NSLocalizedStringFromTable(key, tbl, comment) \</span></span><br><span class="line">    [<span class="built_in">NSBundle</span>.mainBundle localizedStringForKey:(key) value:<span class="string">@""</span> table:(tbl)]</span><br><span class="line"><span class="meta">#define NSLocalizedStringFromTableInBundle(key, tbl, bundle, comment) \</span></span><br><span class="line">    [bundle localizedStringForKey:(key) value:<span class="string">@""</span> table:(tbl)]</span><br><span class="line"><span class="meta">#define NSLocalizedStringWithDefaultValue(key, tbl, bundle, val, comment) \</span></span><br><span class="line">    [bundle localizedStringForKey:(key) value:(val) table:(tbl)]</span><br></pre></td></tr></table></figure>
<p>可以看到实际上就是从mainBundle中取出了指定的String文件 ， 然后根据我们在代码中定义的 ‘key’ 值取出value</p>
<p>这是一种情况 . 有的时候我们要指定我们的string文件名字而不使用上面的那个默认名字 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *tips = <span class="built_in">NSLocalizedStringFromTableInBundle</span>(<span class="string">@"wait"</span>, <span class="string">@"TDFOSLocalizable"</span>, [<span class="built_in">NSBundle</span> bundleForClass:[<span class="keyword">self</span> <span class="keyword">class</span>]], <span class="string">@"some tips to tell user wait"</span>)；</span><br></pre></td></tr></table></figure>
<p>这里面多出来两个参数 ， 第一个是我们要指定的string文件名字 ， 第二个就是要从哪个bundle中取 ， 这个bundle的问题我们下面就会讲到 。</p>
<h2 id="脚本替换"><a href="#脚本替换" class="headerlink" title="脚本替换"></a>脚本替换</h2><p>那么在我们工程很大的情况下我们要把全部的字符串都替换为前缀为NSLocalizedString的形式人工手动替换肯定是不行的 ， 又慢又不安全 ， 没准复制粘贴的时候还把原来的key改错了 。 这里贴一段python的实例代码 ，您可以稍加改动运行替换工程中的string前缀 。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">folderPath = <span class="string">'/Users/felix/Documents/2dfire/TDFOpenShop/TDFOpenShop/Classes'</span></span><br><span class="line">stringToReplace = <span class="string">'NSLocalizedString'</span></span><br><span class="line">stringReplaceTo = <span class="string">'TDFOSLocalizedString'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan_files</span><span class="params">(rootdir)</span>:</span></span><br><span class="line">    files = []</span><br><span class="line">    <span class="keyword">for</span>  parent, dirnames, filenames  <span class="keyword">in</span>  os.walk(rootdir):</span><br><span class="line">        <span class="keyword">for</span>  filename  <span class="keyword">in</span>  filenames:</span><br><span class="line">            <span class="keyword">if</span> len(filename.split(<span class="string">'.'</span>,<span class="number">1</span>))&gt;<span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> filename.split(<span class="string">'.'</span>,<span class="number">1</span>)[<span class="number">1</span>] == <span class="string">'m'</span>:</span><br><span class="line">                    files.append(os.path.join(parent, filename))</span><br><span class="line">    <span class="keyword">return</span> files</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replaceStringIn</span><span class="params">(file)</span>:</span></span><br><span class="line">    code = open(file,<span class="string">'r+'</span>)</span><br><span class="line">    text = code.read()</span><br><span class="line">    code.seek(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    code.write(text.replace(stringToReplace,stringReplaceTo))</span><br><span class="line">    code.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    files = scan_files(folderPath)</span><br><span class="line">    <span class="keyword">for</span> filePath <span class="keyword">in</span> files:</span><br><span class="line">        replaceStringIn(filePath)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>这里面我是把以前的NS开头的宏替换为自定义的宏 ， 大同小异 ， 可以参照这个修改下即可 。</p>
<h2 id="编译运行测试"><a href="#编译运行测试" class="headerlink" title="编译运行测试"></a>编译运行测试</h2><p>当我们全部修改好以后肯定是要测试下显示对不对的 。<br>这个时候按下command+B，编译运行 。</p>
<p>有两种方法可以快速将App语言切换掉</p>
<ul>
<li>打开模拟器或真机 ， general -&gt; setting -&gt; lang ,不过这样比较繁琐 。</li>
<li>点击导航栏上的模拟器图标左边的schema选项 ， 选择editSchema -&gt; Run -&gt; Options -&gt;Application Language 直接改为你需要验证的语言运行就可以啦 。</li>
</ul>
<h1 id="模块内单独配置"><a href="#模块内单独配置" class="headerlink" title="模块内单独配置"></a>模块内单独配置</h1><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>很多时候我们的工程体量大到一定程度的时候都会模块化掉 ， 几个人或者一个人负责一个模块 ， 而有的模块是要作为SDK提供外部interface使用的 。</p>
<p>当你把SDK提供出去的时候 ， 我们期望的效果是在其他人（其他工程）内部运行的、我们的SDK也能够国际化显示 。</p>
<p>但是在我们整个工程的string文件包含几千上万条的时候显然不需要全部移动到模块内 。</p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>所以在这里面我们要做的就是把需要的使用到的字符串和翻译好的value从主工程迁移到模块内部 。</p>
<h2 id="解决方案：使用cocoapods集成的模块化内部进行国际化"><a href="#解决方案：使用cocoapods集成的模块化内部进行国际化" class="headerlink" title="解决方案：使用cocoapods集成的模块化内部进行国际化"></a>解决方案：使用cocoapods集成的模块化内部进行国际化</h2><p>这里我使用的是cocoapods1.2.1 。关于cocoapod的使用详见我的另一篇文章 。</p>
<p>我们先把主工程的国际化文件的文件夹复制到我们的模块路径下面</p>
<p>我们在模块内部有一个配置文件 ‘xxx.podspec’</p>
<p>里面添加这样一段配置</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.resources  = <span class="string">'xxx/*.&#123;xib,jpg,png,xcassets&#125;'</span>,<span class="string">'xxx/*.lproj'</span></span><br></pre></td></tr></table></figure>
<p>主要注意后面 , 这里就把我们刚复制来的国际化问价加入了模块的资源中 ，这时 ，如果我们不想用跟主工程一样的名字 ，Localizable.strings ，可以把这个名字也给改掉 ， 比如 abc.strings</p>
<h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><p>这里为了有别于主工程的国际化 ， 我们把strings文件改名为 abc.strings 然后在模块内新建一个头文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef TDFOSLocalizeMacro_h</span></span><br><span class="line"><span class="meta">#define TDFOSLocalizeMacro_h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define TDFOSLocalizedString(key, comment) \</span></span><br><span class="line"><span class="built_in">NSLocalizedStringFromTableInBundle</span>(key, <span class="string">@"abc"</span>, [<span class="built_in">NSBundle</span> bundleForClass:[<span class="keyword">self</span> <span class="keyword">class</span>]], comment)</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif /* TDFOSLocalizeMacro_h */</span></span><br></pre></td></tr></table></figure>
<p>这里可以使用上面的脚本再次替换字符串前缀 ， 然后运行下看看是否替换成功了呢 。</p>
<p>这里主要重新pod install下 ， 否则cocoapods不会帮我们把资源引入包内 。</p>
<p>ps: 别忘了删掉主工程中移除来的字符串 ！！！</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>基本用法暂时介绍到这里 ， 关于模块化和国际化的东西要多了解一下NSbundle这个类 。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

      

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
      </div>
      
        <div align="center" style="margin-top: 30px;"><hr class="hr" style="margin:0px; height:3px;"></div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2018 匀昊的旧笔记 All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				UV : <span id="busuanzi_value_site_uv"></span> |  
				PV : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>


  <script src="/js/home.js"></script>










	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            匀昊的旧笔记
          </div>
          <div class="panel-body">
            Copyright © 2018 匀昊 All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
</body>
</html>